# Implementation Plan: Namespace Resolution for Migrations

**Branch**: `002-drizzle-namespace-fix` | **Date**: 2026-01-23 | **Spec**: /specs/002-drizzle-namespace-fix/spec.md
**Input**: Feature specification from `/specs/002-drizzle-namespace-fix/spec.md`

## Summary

Ensure unqualified schema references resolve to a configurable default schema (SQLUser fallback) for the primary backend so migrations and runtime queries do not conflict, while preserving reference backend behavior.

## Technical Context

**Language/Version**: TypeScript (Node.js, Next.js 16.1.0 canary)  
**Primary Dependencies**: Drizzle ORM, Postgres.js driver, iris-pgwire, Docker Compose  
**Storage**: PostgreSQL (reference backend) and IRIS via pgwire (primary backend)  
**Testing**: `npm test` and `npm run lint`  
**Target Platform**: Local Dockerized services  
**Project Type**: Web application (apps/sim + packages/db)  
**Performance Goals**: N/A (developer workflow focus)  
**Constraints**: Preserve reference backend behavior; honor explicit schemas (enforced at both DB initialization and proxy layers); keep migration metadata schema unchanged; validate DB_DEFAULT_SCHEMA adoption in migration runner
**Scale/Scope**: Local developer stacks

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- Constitution file is a placeholder template with no enforceable principles. No gates apply.

## Project Structure

### Documentation (this feature)

```text
specs/002-drizzle-namespace-fix/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md
```

### Source Code (repository root)

```text
apps/
└── sim/
    ├── lib/
    └── .env.example

packages/
└── db/
    ├── drizzle.config.ts
    └── index.ts

iris/
├── Dockerfile.iris
├── sim_sql_patch.py
└── patch_pgwire_protocol.py

docker-compose.iris.yml
docker-compose.local.yml
```

**Structure Decision**: Web application with shared database package and dockerized dev stacks.

## Phase 0: Outline & Research

Research output: `/specs/002-drizzle-namespace-fix/research.md`.

## Phase 1: Design & Contracts

Design output:
- `/specs/002-drizzle-namespace-fix/data-model.md`
- `/specs/002-drizzle-namespace-fix/contracts/`
- `/specs/002-drizzle-namespace-fix/quickstart.md`

## Phase 2: Task Planning

Task output: `/specs/002-drizzle-namespace-fix/tasks.md` (generated by `/speckit.tasks`).
